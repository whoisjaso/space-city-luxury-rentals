---
phase: 06-guest-booking-flow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/src/pages/BookingPage.tsx
  - app/src/pages/BookingStatusPage.tsx
  - app/src/hooks/useBooking.ts
  - app/src/components/BookingForm.tsx
  - app/src/components/TermsModal.tsx
autonomous: true

must_haves:
  truths:
    - "User can complete the entire booking flow in under 60 seconds without creating an account"
    - "Booking form validates input in real time (valid email, valid phone, dates in future, required fields)"
    - "User must acknowledge rental terms before submitting (checkbox)"
    - "After submitting, user sees confirmation page with unique confirmation code and pending status"
    - "User can visit status page, enter confirmation code or email, and see booking status with admin notes"
    - "Booking form pre-selects vehicle if ?vehicle=slug query param is present"
    - "Form submits to Supabase bookings table (or shows demo confirmation in seed mode)"
  artifacts:
    - path: "app/src/pages/BookingPage.tsx"
      provides: "Guest booking form page"
    - path: "app/src/pages/BookingStatusPage.tsx"
      provides: "Booking status lookup page"
    - path: "app/src/components/BookingForm.tsx"
      provides: "Multi-field booking form with validation"
    - path: "app/src/hooks/useBooking.ts"
      provides: "Booking mutation and status query hooks"
---

<objective>
Build the complete guest booking flow — from "I want this" to "booking submitted" in under 60 seconds, with confirmation code and status checking.

Purpose: This is the money-maker. A frictionless booking form that captures guest details, validates input, requires terms acceptance, and produces a confirmation code. The status page lets guests check their booking anytime. Zero account creation required.

Output: BookingPage with form and validation, BookingStatusPage with lookup, confirmation display, and Supabase integration (with demo mode fallback).
</objective>

<tasks>
<task id="1" name="Create booking form, status page, and hooks" type="code">
Create the following:

1. `app/src/hooks/useBooking.ts`:
   - `useCreateBooking()`: TanStack Query mutation
     - If Supabase configured: insert into bookings table, return the row with confirmation_code
     - If demo mode: generate a fake confirmation code (random 8-char uppercase alphanumeric), return mock booking object
     - Input: { vehicle_id: string, guest_name: string, guest_email: string, guest_phone: string, start_date: string, end_date: string, terms_accepted: boolean }
   - `useBookingStatus(code: string)`: TanStack Query hook
     - If Supabase configured: query bookings where confirmation_code = code (case insensitive), join vehicle name
     - If demo mode: return mock booking with "pending" status
     - Enabled only when code has 8+ characters
   - `useBookingsByEmail(email: string)`: TanStack Query hook
     - If Supabase configured: query bookings where guest_email = email
     - If demo mode: return empty array

2. `app/src/components/BookingForm.tsx`:
   Props: { vehicles: Vehicle[], preselectedSlug?: string, onSuccess: (booking: { confirmation_code: string }) => void }

   Form fields (single page, no multi-step):
   - Vehicle selector: dropdown with vehicle names and daily prices (pre-selected if slug provided)
   - Start date: date input (min = tomorrow)
   - End date: date input (min = start date + 1)
   - Guest name: text input
   - Guest email: email input
   - Guest phone: tel input with format hint "(xxx) xxx-xxxx"
   - Terms checkbox: "I agree to the rental terms and conditions" with link to view terms
   - Submit button: "Reserve Now" (gold background, dark text, full width)

   Validation (real-time, on blur):
   - All fields required
   - Email: basic regex validation
   - Phone: at least 10 digits
   - Start date: must be today or later
   - End date: must be after start date
   - Terms: must be checked
   - Show inline error messages below invalid fields (red text)
   - Disable submit until all fields valid
   - Show loading spinner on submit button while mutation is pending

   Styling:
   - Dark background inputs with white/10 borders, focus ring in gold
   - Clean, minimal form design matching the luxury brand
   - museo-label for labels, museo-body for inputs

3. `app/src/components/TermsModal.tsx`:
   - Simple modal with rental terms text
   - Includes: rental period terms, deposit info, damage policy, cancellation policy
   - Close button
   - Dark background overlay with centered white panel

4. Replace `app/src/pages/BookingPage.tsx`:
   - Read ?vehicle=slug from URL search params
   - Load vehicles list using useVehicles hook (for dropdown)
   - Show page header: "RESERVE NOW" label + "Your Weekend. Your Statement." headline
   - BookingForm component
   - On success: show confirmation panel with:
     - Green checkmark icon
     - "Booking Confirmed" heading
     - Confirmation code displayed large (monospace, gold, easy to copy)
     - "Copy Code" button
     - Booking summary (vehicle, dates, name)
     - Status: "Pending — Joey will review your request"
     - "Check Booking Status" link to /book/{confirmation_code}
     - "Browse More Vehicles" link to /fleet

5. Replace `app/src/pages/BookingStatusPage.tsx`:
   - If URL has :code param, auto-lookup that booking
   - If no code param, show lookup form:
     - "Enter your confirmation code or email" with input field
     - Search button
   - Display booking details when found:
     - Vehicle name
     - Dates
     - Status badge: pending (yellow), approved (green), declined (red)
     - Admin notes (if any)
     - Confirmation code
   - Not found state: "No booking found" with option to try again

Commit message: feat(06-01): guest booking flow with form, validation, confirmation, and status check
</task>
</tasks>
